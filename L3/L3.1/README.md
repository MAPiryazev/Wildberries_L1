# Сервис отложенной отправки сообщений (L3.1)

Сервис позволяет создавать отложенные уведомления, которые будут отправлены в указанное время.

### Архитектура

1. **HTTP API** - принимает запросы на создание, проверку статуса и отмену уведомлений
2. **Delayed Queue** - очередь для сообщений в rabbitMQ, которые должны быть отправлены позже
3. **Delayed Worker** - воркер, который каждые 5 секунд проверяет delayed_queue и переносит сообщения в **ready_queue** когда наступает время отправки
4. **Ready Queue** - очередь готовых к отправке сообщений
5. **Ready Worker** - воркер, который обрабатывает ready_queue и отправляет сообщения через Gmail
6. **Redis** - хранит статусы уведомлений и позволяет быстро получать информацию о них

### Как запустить

1. Создайте файл `environment/.env` и запишите туда ваши данные

```
#rabbitmq 
RABBITMQ_DEFAULT_USER=
RABBITMQ_DEFAULT_PASS=

#redis
REDIS_PASSWORD=

#google
GMAIL_SERVICE_FROM= почта с которой будут отправляться письма (уведомления)
GMAIL_SERVICE_PASSWORD= API ключ от гугл аккаунта (почты)
```

2. Запустите RabbitMQ и Redis через docker-compose:

```bash
docker-compose up -d
```

3. Запустите приложение:

```bash
go run cmd/app/main.go
```

4. Ручка на создание уведомления:

```bash
curl -X POST http://localhost:8080/notify \
  -H "Content-Type: application/json" \
  -d '{
    "to": "recipient@example.com",
    "subject": "Test",
    "body": "This is a test message",
    "sendAt": "2025-12-31T23:59:00Z"
  }'
```

5. ручка на проверку статуса:

```bash
curl "http://localhost:8080/notify/status?id=YOUR_MESSAGE_ID"
```

## Как работает

1. Пользователь создает уведомление через HTTP API с временем отправки в будущем 
2. Сообщение сохраняется в Redis со статусом "scheduled"
3. Сообщение публикуется в `delayed_queue`
4. **Delayed Worker** каждые 5 секунд
  Читает сообщение из `delayed_queue`
  Проверяет, наступило ли время отправки
  Если да - переносит в `ready_queue`
  Если нет - возвращает обратно в `delayed_queue`
5. **Ready Worker** обрабатывает сообщения из `ready_queue`
  Отправляет через Gmail
  Обновляет статус в Redis

TODO:
Если бы времени было больше, то можно было бы прикрутить сюда:
 - Middleware для логирования запросов через api
 - Структуру validator для тщательной проверки запросов
 - Кастомные ошибки чтобы они были понятнее и тщательнее обрабатывались
 - Модульные и интеграционные тесты (mockgen)
 - Упаковать код сервиса в отдельный docker контейнер